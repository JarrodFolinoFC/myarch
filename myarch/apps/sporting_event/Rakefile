# frozen_string_literal: true

require 'rake'
require_relative '../../lib/ruby/bunny_connection_factory'
require_relative '../../lib/ruby/event_listener'
require_relative '../../lib/ruby/event_publisher'

require_relative 'db/db_connection'
require_relative 'models/sporting_event'
require_relative 'lib/csv_reader'

desc 'DB Connect'
task :db_connect do
  DbConnection.connect!
end

desc 'Run Create Sporting Event Listener'
task run_listener: :db_connect do
  EventListener.new('sporting_event_create').listen do |payload|
    SportingEvent.from_json(payload).map(&:save!)
  end
end

desc 'Run Sporting Event Created Listener'
task run_listener: :db_connect do
  EventListener.new('sporting_event_created').listen do |payload|
    SportingEvent.from_json(payload).each do |se|
      puts se
    end
  end
end

desc 'Publish Sporting Event'
task :publish do
  EventPublisher
    .new('test_exchange', 'sporting_event_create', 'key1')
    .send do
    CsvReader.parse_csv('data.csv')
  end
end

desc 'Sporting Event Summary'
task summary: :db_connect do
  puts '' "
  SportingEvent
  count #{SportingEvent.count}
  " ''
end

desc 'Clean Sporting Event'
task clean: :db_connect do
  SportingEvent.delete_all
end

desc 'Migrate DB'
task db_migrate: :db_connect do
  require_relative 'db/migrate/migration_one'
end
