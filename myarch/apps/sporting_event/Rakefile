# frozen_string_literal: true

require 'rake'
require '../../libs/heart_core/lib/heart_core'

require_relative 'models/sporting_event'
require_relative 'lib/csv_reader'

%w[about db default_publish_attributes default_listener_attributes reply_to_attributes bunny].each do |file|
  require_relative "config/#{file}"
end

desc 'Clean Sporting Event'
task clean: 'db:connect' do
  Heart::Core::QueueManager.new.purge_all(%w[sporting_event sporting_event_created sporting_event_created])
  SportingEvent.delete_all
  Heart::Core::OutboxMessage.delete_all
end

namespace :db do
  desc 'DB Connect'
  task :connect do
    require_relative 'config/db'
    Heart::Core::DbConnection.connect!
  end

  desc 'Migrate DB'
  task migrate: 'db:connect' do
    require_relative 'db/migrate/migration_one'
    require_relative 'db/migrate/db_outbox'
  end
end

desc 'Sporting Event Summary'
task summary: 'db:connect' do
  puts '' "
  Discovery Summary
  #{Heart::Core::Discovery::Registry.new.summary('app/')}
  " ''

  puts '' "
  SportingEvent
  count #{SportingEvent.count}

  Heart::Core::OutboxMessage
  sent count #{Heart::Core::OutboxMessage.where.not(last_published_at: nil).count}
  unsent count #{Heart::Core::OutboxMessage.where(last_published_at: nil).count}

  Last Unsent Headers
  #{Heart::Core::OutboxMessage.where(last_published_at: nil).last&.headers}
  " ''
end

namespace :run do
  desc 'Run Sporting Event REST Server'
  task :server do
    ruby "#{__dir__}/api/rest_server.rb"
  end

  desc 'Run Create Sporting Event Listener'
  task create_listener: 'db:connect' do
    Heart::Core::EventListener.instance('sporting_event_create').listen do |payload|
      sporting_events = Heart::Core::ActiveModelHelper.build_all(SportingEvent, JSON.parse(payload))
      sporting_events.map(&:save!)
      Heart::Core::Logger.instance.debug("#{sporting_events.size} SportingEvent objects created")
    end
  end

  desc 'Run Sporting Event Created Listener'
  task created_listener: 'db:connect' do
    Heart::Core::EventListener.instance('sporting_event_created').listen { |payload| puts payload }
  end

  desc 'Run Polling Publisher'
  task outbox_poller: 'db:connect' do
    Heart::Core::OutboxPoller.new.run
  end
end

desc 'Publish All Sporting Events'
task :publish_all, [:publisher_class] => 'db:connect' do |_t, args|
  args.with_defaults(publisher_class: 'Heart::Core::DirectPublisher')
  publisher_class = Object.const_get(args[:publisher_class])
  publisher_class.instance('sporting_event_create').publish { CsvReader.parse_csv('data.csv') }
end

desc 'Publish All Sporting Events'
task :publish_test => 'db:connect' do
  settings = Heart::Core::Config.instance['default/rabbit/publish_attributes']
  settings = Heart::Core::Config.evaluate_hash(settings)
  Heart::Core::DirectPublisher.instance('sporting_event_create').publish_with_settings(settings) {
    CsvReader.parse_csv('data.csv')
  }
end

desc 'Publish Single Sporting Event'
task :publish, [:internal_id] do |_t, args|
  args.with_defaults(publisher_class: 'Heart::Core::DirectPublisher')
  internal_id = args[:internal_id]
  publisher_class = Object.const_get(args[:publisher_class])
  data = JSON.parse(CsvReader.parse_csv('data.csv')).select { |obj| obj['internal_id'] == internal_id }.to_json
  publisher_class.instance('sporting_event_create').publish { data }
end

desc 'Run Reply Listener'
task :reply_listener do
  reply_topic = Heart::Core::Config.instance['default/rabbit/publish_attributes'][:reply_to]
  Heart::Core::EventListener.instance('reply_queue').listen do |payload|
    puts payload
  end
end

desc 'Run DB Reply Listener'
task :db_reply_listener do
  Heart::Core::EventListener.instance('reply_to').listen do |payload|
    Heart::Core::OutboxMessage.ack!(payload[:correlation_id],
                                    payload[:application_name],
                                    payload[:message])
  end
end

task :bunny_test do
  Heart::Core::EventListener.instance('sporting_event').listen do |payload|
    sporting_events = Heart::Core::ActiveModelHelper.build_all(SportingEvent, JSON.parse(payload))
    sporting_events.map(&:save!)
  end
end